<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personel/Stajyer Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        body {
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        .container-fluid {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0 !important;
            overflow: hidden;
        }

        @media (max-width: 767.98px) {
            body {
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
                padding: 1rem;
            }
            
            .container-fluid {
                overflow: visible;
            }

            .row {
                margin: -0.5rem;
            }

            .col-md-5, .col-md-7 {
                padding: 0.5rem;
            }

            .card {
                height: auto !important;
                margin-bottom: 0;
            }

            .card-body {
                max-height: none !important;
            }

            .scrollable-section {
                max-height: 60vh;
                overflow-y: auto;
            }
        }

        /* SweetAlert2 modal açıldığında body yüksekliğini koru */
        body.swal2-shown {
            height: 100vh !important;
        }

        body.swal2-height-auto {
            height: 100vh !important;
        }

        /* Container yüksekliğini sabitle */
        .container-fluid {
            min-height: 100vh !important;
            height: auto !important;
        }

        /* Card body'lerin içeriğe göre esnek kalmasını sağla */
        .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 1.5rem;
            height: 100%;
        }
        .row {
            flex: 1;
            min-height: 0;
        }
        .card {
            height: 100%;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 2rem);
        }
        .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 1.5rem;
        }
        #workForm {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 0.75rem;
        }
        #workForm .mb-3 {
            margin-bottom: 0 !important;
            display: flex;
            flex-direction: column;
        }
        #workForm textarea {
            max-height: 300px;
            resize: vertical;
            overflow-y: auto;
        }
        #workForm .btn {
            margin-top: auto;
            width: fit-content;
        }
        .work-card {
            border-left: 4px solid #007bff;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            padding: 0.75rem;
            width: 100%;
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            height: fit-content;
        }
        .work-card:last-child {
            margin-bottom: 0;
        }
        .work-card .card-body {
            padding: 0;
            width: 100%;
            overflow: hidden;
            height: auto;
            min-height: auto;
            flex: 0 0 auto;
        }
        .work-card:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .work-card.completed {
            border-left-color: #28a745;
        }
        .work-card.in-progress {
            border-left-color: #ffc107;
        }
        .work-card .card-title {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        .work-card .mb-2 {
            margin-bottom: 0.5rem !important;
        }
        .work-card .mt-2 {
            margin-top: 0.5rem !important;
        }
        .work-card .text-break {
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }
        .work-card a {
            word-wrap: break-word;
            overflow-wrap: break-word;
            display: inline-block;
            max-width: 100%;
        }
        .scrollable-section {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            padding-right: 15px;
            padding-left: 5px;
            margin-right: -10px;
        }
        .scrollable-section::-webkit-scrollbar {
            width: 5px;
        }
        .scrollable-section::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .scrollable-section::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .revision-section {
            display: none;
        }
        .link-display {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        .link-text {
            max-width: calc(100% - 40px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .link-text a {
            color: #0d6efd;
            text-decoration: none;
        }
        .link-text a:hover {
            text-decoration: underline;
        }
        .edit-link-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            margin-left: 4px;
            flex-shrink: 0;
            border: none;
            background: transparent;
            color: #6c757d;
            transition: all 0.2s;
        }
        .edit-link-btn:hover {
            color: #0d6efd;
            background: rgba(13, 110, 253, 0.1);
        }
        .link-edit {
            display: none;
            align-items: center;
            gap: 8px;
            width: 100%;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        .link-edit input {
            flex: 1;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 0.375rem 0.75rem;
        }
        .link-edit input:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            outline: none;
        }
        .link-edit button {
            padding: 0.375rem 0.75rem;
            border: none;
            background: transparent;
            color: #6c757d;
            transition: all 0.2s;
            border-radius: 4px;
        }
        .link-edit button:hover {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        .section-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 12px;
        }
        .section-nav-content {
            display: flex;
            align-items: center;
            width: 100%;
        }
        .nav-buttons {
            display: flex;
            gap: 0.75rem;
        }
        .section-container {
            display: flex;
            gap: 1rem;
            flex: 1;
            overflow: hidden;
        }
        .section-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .active-section {
            border: 2px solid #007bff;
            border-radius: 0.375rem;
        }
        .card-title {
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 1.5rem !important;
        }
        .section-title {
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 0 !important;
            flex: 1;
        }
        .alert {
            margin-bottom: 0.5rem;
            padding: 0.5rem 0.75rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .reviews-section {
            margin-top: 0.5rem;
            margin-bottom: 0;
        }
        .complete-btn-container {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.75rem;
            margin-bottom: 0;
        }
        .complete-btn-container .btn-success {
            padding: 0.25rem 0.75rem;
            font-weight: 500;
        }
        .work-card p {
            margin-bottom: 0.5rem;
        }
        .work-card p:last-child {
            margin-bottom: 0;
        }
        .work-card .alert:last-child {
            margin-bottom: 0;
        }
        .edit-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        .edit-content {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .edit-buttons {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        .work-card .edit-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border: none;
            background: transparent;
            color: #6c757d;
            transition: all 0.2s;
            border-radius: 4px;
        }
        .work-card .edit-btn:hover:not(:disabled) {
            color: #0d6efd;
            background: rgba(13, 110, 253, 0.1);
        }
        .work-card .edit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            display: none;
        }
        .edit-input {
            flex: 1;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 0.375rem 0.75rem;
        }
        .edit-input:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            outline: none;
        }
        /* Navigation button styles */
        .nav-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid #dee2e6;
            background: white;
            color: #0d6efd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background: #f8f9fa;
            border-color: #0d6efd;
        }

        .nav-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .nav-btn i {
            font-size: 1rem;
        }

        .nav-btn.home-btn {
            background: #e7f1ff;
            border-color: #0d6efd;
        }

        .nav-btn.home-btn:hover {
            background: #d0e3ff;
        }

        /* Action button styles */
        .action-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .action-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .action-btn i {
            font-size: 1rem;
        }

        .action-btn.btn-complete {
            background: #198754;
            color: white;
            border-color: #198754;
        }

        .action-btn.btn-complete:hover {
            background: #157347;
            border-color: #157347;
        }

        .action-btn.btn-revise {
            background: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .action-btn.btn-revise:hover {
            background: #0b5ed7;
            border-color: #0b5ed7;
        }

        .action-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Status badge styles */
        .status-badge {
            padding: 0.4rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .status-badge i {
            font-size: 0.8rem;
        }

        .status-badge.in-progress {
            background-color: #fff3cd;
            color: #997404;
            border: 1px solid #ffe69c;
        }

        .status-badge.completed {
            background-color: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
        }

        /* Form styles */
        .form-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .form-content {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
        }

        .form-select, .form-control {
            border: 1.5px solid #dee2e6;
            border-radius: 8px;
            padding: 0.625rem 1rem;
            transition: all 0.2s ease;
            background-color: #f8f9fa;
        }

        .form-select:focus, .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
            background-color: #fff;
        }

        .form-select:hover, .form-control:hover {
            border-color: #0d6efd;
            background-color: #fff;
        }

        .form-control::placeholder {
            color: #adb5bd;
        }

        .form-group {
            margin-bottom: 0;
            position: relative;
            flex-shrink: 0;
        }

        .form-group:last-child {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .form-control {
            max-height: none;
            min-height: 80px;
        }

        .form-group:last-child .form-control {
            flex: 1;
            min-height: 80px;
            max-height: 150px;
        }

        textarea.form-control {
            resize: none;
        }

        .form-submit-btn {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 500;
            background: linear-gradient(45deg, #0d6efd, #0b5ed7);
            border: none;
            color: white;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(13, 110, 253, 0.2);
            margin-top: 1.25rem;
            flex-shrink: 0;
        }

        .form-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(13, 110, 253, 0.25);
            background: linear-gradient(45deg, #0b5ed7, #0a58ca);
        }

        .form-submit-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(13, 110, 253, 0.2);
        }

        /* Select placeholder styles */
        .form-select {
            color: #495057;
        }

        .form-select option[value=""][disabled] {
            display: none;
        }

        .form-select:required:invalid {
            color: #6c757d;
        }

        .nav-date {
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            background: white;
            color: #0d6efd;
            margin: 0 0.5rem;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .nav-date:hover {
            border-color: #0d6efd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-date:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .video-list-item {
            padding: 1.5rem;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1.25rem;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .video-list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-color: #dee2e6;
        }

        .video-list-item .alert-light {
            border-radius: 8px;
            padding: 1rem 1.25rem;
            transition: all 0.2s ease;
        }

        .video-list-item:hover .alert-light {
            background: #fff !important;
            border-color: #dee2e6 !important;
        }

        .video-list-item .fw-medium {
            color: #2c3e50;
            font-size: 1.05rem;
        }

        .video-list-item .text-muted {
            color: #6c757d !important;
        }

        .video-list-item .btn {
            padding: 0.6rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .video-list-item .btn:hover {
            transform: translateY(-1px);
        }

        .video-list-item .btn-primary:hover {
            box-shadow: 0 4px 8px rgba(13, 110, 253, 0.25) !important;
        }

        .video-list-item .badge {
            font-weight: 500;
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
        }

        .video-meta {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            color: #6c757d;
            font-size: 0.9rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .video-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .video-meta i {
            font-size: 1.1rem;
            color: #0d6efd;
        }

        .revision-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.85rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            background: linear-gradient(45deg, #e3f2fd, #bbdefb);
            color: #0d6efd;
            box-shadow: 0 2px 4px rgba(13, 110, 253, 0.1);
            border: 1px solid rgba(13, 110, 253, 0.1);
        }

        .revision-badge i {
            font-size: 0.85rem;
            margin-right: 0.35rem;
        }

        .review-btn {
            padding: 0.6rem 1.5rem;
            border-radius: 12px;
            font-weight: 500;
            font-size: 0.95rem;
            background: linear-gradient(45deg, #0d6efd, #0b5ed7);
            border: none;
            color: white;
            transition: all 0.2s ease;
            box-shadow: 0 3px 6px rgba(13, 110, 253, 0.2);
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            position: relative;
            overflow: hidden;
        }

        .review-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), transparent);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .review-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 8px rgba(13, 110, 253, 0.25);
        }

        .review-btn:hover::after {
            opacity: 1;
        }

        .review-btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 6px rgba(13, 110, 253, 0.2);
        }

        .review-btn i {
            font-size: 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 2.5rem;
            color: #adb5bd;
            margin-bottom: 1rem;
        }

        .empty-state p {
            margin-bottom: 0;
            font-size: 1rem;
        }

        /* Review section styles */
        .reviews-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .review-item {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .review-item:last-child {
            margin-bottom: 0;
        }

        .admin-review {
            background: #fff5f5;
            border-color: #dc3545;
            border-left: 4px solid #dc3545;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .review-actions {
            flex-shrink: 0;
            margin-left: 1rem;
        }

        .alert-danger {
            background-color: #fff5f5;
            border-color: #dc3545;
            border-left: 4px solid #dc3545;
            color: #842029;
        }

        .alert-danger small.text-muted {
            color: #dc3545 !important;
        }

        .reviews-section .action-btn.btn-revise {
            margin-top: 0.5rem;
        }

        .reviews-section {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 0.5rem;
            margin-bottom: 0;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
        }

        .reviews-section::-webkit-scrollbar {
            width: 5px;
        }

        .reviews-section::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .reviews-section::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

        /* Updated Navigation button styles */
        .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            padding: 0.75rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: none;
            background: #fff;
            color: #0d6efd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 48px;
            height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.25);
            background: #f0f7ff;
        }

        .nav-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(13, 110, 253, 0.1);
        }

        .nav-btn i {
            font-size: 1.25rem;
            transition: transform 0.3s ease;
        }

        .nav-btn.home-btn {
            background: linear-gradient(145deg, #0d6efd, #0a58ca);
            color: white;
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
        }

        .nav-btn.home-btn:hover {
            background: linear-gradient(145deg, #0b5ed7, #084298);
            box-shadow: 0 6px 16px rgba(13, 110, 253, 0.4);
        }

        .nav-btn.switch-btn {
            position: relative;
            overflow: hidden;
            width: 48px;
            height: 48px;
            background: linear-gradient(145deg, #ffffff, #f0f7ff);
            border: 2px solid #e7f1ff;
        }

        .nav-btn.switch-btn .switch-icon {
            display: flex;
            align-items: center;
            gap: 4px;
            transition: transform 0.3s ease;
        }

        .nav-btn.switch-btn .switch-icon i:first-child {
            color: #0d6efd;
            font-size: 1.1rem;
        }

        .nav-btn.switch-btn .switch-icon i:last-child {
            color: #6c757d;
            font-size: 1.1rem;
        }

        .nav-btn.switch-btn:hover {
            border-color: #0d6efd;
        }

        .nav-btn.switch-btn[data-section="1"] .switch-icon {
            transform: rotate(180deg);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #ffab00);
            border: none;
            color: #000;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(45deg, #ffab00, #ff9100);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(255, 171, 0, 0.2);
        }

        .btn-warning:disabled {
            background: #ffd54f;
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-primary, .btn-warning {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(13, 110, 253, 0.2);
        }

        .video-actions-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 12px;
            width: 100%;
        }

        .video-action-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            border: none;
            min-width: 180px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .video-action-btn.view-btn {
            background: linear-gradient(145deg, #0d6efd, #0b5ed7);
            color: white;
        }

        .video-action-btn.view-btn:hover {
            background: linear-gradient(145deg, #0b5ed7, #084298);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
        }

        .video-action-btn.revise-btn {
            background: linear-gradient(145deg, #ffc107, #ffab00);
            color: #000;
        }

        .video-action-btn.revise-btn:hover:not(:disabled) {
            background: linear-gradient(145deg, #ffab00, #ff9100);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 171, 0, 0.3);
        }

        .video-action-btn.revise-btn:disabled {
            background: linear-gradient(145deg, #e9ecef, #dee2e6);
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="row g-4">
            <!-- Sol Panel - İş Tanımlama -->
            <div class="col-md-5">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="section-nav">
                            <div class="section-nav-content">
                                <h5 class="section-title">Yeni İş Tanımla</h5>
                                <div class="nav-buttons">
                                    <a href="/" class="nav-btn home-btn">
                                        <i class="bi bi-house-door"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <form id="workForm" class="form-container">
                            <div class="form-content">
                                <div class="form-group">
                                    <label class="form-label">Personel/Stajyer</label>
                                    <select id="employeeSelect" class="form-select" required>
                                        <option value="" disabled selected hidden>Personel/Stajyer Seçiniz</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">İş Türü</label>
                                    <select id="workType" class="form-select" required>
                                        <option value="" disabled selected hidden>İş Türü Seçiniz</option>
                                        <option value="video">Video</option>
                                        <option value="software">Yazılım</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">İş Tanımı</label>
                                    <textarea id="description" class="form-control" rows="3" required 
                                        placeholder="Yapılacak işin detaylı açıklamasını buraya yazınız..."></textarea>
                                </div>
                            </div>

                            <button type="submit" class="form-submit-btn">
                                <i class="bi bi-plus-circle me-2"></i>İş Tanımla
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sağ Panel - Bugünkü İşler/Tamamlanmış Videolar -->
            <div class="col-md-7">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column">
                        <div class="section-nav">
                            <div class="section-nav-content">
                                <h5 class="section-title" id="sectionTitle">Bugünkü İşlerim</h5>
                                <div class="nav-buttons">
                                    <input type="date" id="dateFilter" class="nav-date" style="display: none;">
                                    <button class="nav-btn switch-btn" data-section="0" onclick="switchSection(this)">
                                        <div class="switch-icon">
                                            <i class="bi bi-chevron-left"></i>
                                            <i class="bi bi-chevron-right"></i>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Bugünkü İşler -->
                        <div id="todaysWorks" class="scrollable-section"></div>
                        <!-- Tamamlanmış Videolar -->
                        <div id="completedVideosList" class="scrollable-section" style="display: none;">
                            <div class="list-group">
                                <!-- Videos will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Work Completion Modal -->
    <div class="modal fade" id="completeWorkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">İş Tamamlama</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="completeWorkForm">
                            <div class="mb-3">
                            <label class="form-label">Link</label>
                            <input type="url" id="workLink" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="confirmComplete">Tamamla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Review Modal -->
    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Video İnceleme</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="reviewVideoDetails" class="mb-3">
                        <!-- Video details will be loaded here -->
                            </div>
                    <form id="reviewForm">
                        <div class="mb-3">
                            <label class="form-label">İnceleme Yorumu</label>
                            <textarea id="reviewComment" class="form-control" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="confirmReview">İncelemeyi Tamamla</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.all.min.js"></script>
    <script>
        let selectedWorkId = null;
        let selectedVideoId = null;
        const completeWorkModal = new bootstrap.Modal(document.getElementById('completeWorkModal'));
        const reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
        let currentEmployeeId = localStorage.getItem('selectedEmployeeId');
        let activeSection = 0;
        let currentlyReviewingVideo = null; // Add this at the top with other global variables
        let lastCheckTime = null;
        const CHECK_INTERVAL = 10000; // 10 seconds

        document.addEventListener('DOMContentLoaded', async () => {
            // Get today's date in local timezone
            const now = new Date();
            const today = now.getFullYear() + '-' + 
                         String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(now.getDate()).padStart(2, '0');
            
            document.getElementById('dateFilter').value = today;

            // Load employees first
            const hasEmployees = await loadEmployees();
            
            // Only proceed with loading works if we have employees
            if (hasEmployees) {
                const savedEmployeeId = localStorage.getItem('selectedEmployeeId');
                if (savedEmployeeId) {
                    currentEmployeeId = savedEmployeeId;
                    document.getElementById('employeeSelect').value = savedEmployeeId;
                    await loadTodaysWorks(currentEmployeeId);
                } else {
                    await loadTodaysWorks(null);
                }
            }

            // Show today's works section by default
            document.getElementById('completedVideosList').style.display = 'none';
            document.getElementById('sectionTitle').textContent = 'Bugünkü İşlerim';
            document.getElementById('todaysWorks').style.display = '';
            activeSection = 0;

            setupEventListeners();
            startAutoRefresh(); // Auto refresh başlat
        });

        function setupEventListeners() {
            // Employee selection change
            document.getElementById('employeeSelect').addEventListener('change', async (e) => {
                currentEmployeeId = e.target.value;
                if (currentEmployeeId) {
                    localStorage.setItem('selectedEmployeeId', currentEmployeeId);
                    await loadTodaysWorks(currentEmployeeId);
                } else {
                    localStorage.removeItem('selectedEmployeeId');
                    await loadTodaysWorks(null);
                }
                
                // Always show today's works
                document.getElementById('completedVideosList').style.display = 'none';
                document.getElementById('sectionTitle').textContent = 'Bugünkü İşlerim';
                document.getElementById('todaysWorks').style.display = '';
                activeSection = 0;
            });

            // Work type change
            document.getElementById('workType').addEventListener('change', async () => {
                if (currentEmployeeId) {
                    await loadTodaysWorks(currentEmployeeId);
                }
            });

            // Work form submission
            document.getElementById('workForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createWork();
            });

            // Complete work confirmation
            document.getElementById('confirmComplete').addEventListener('click', completeWork);

            // Review confirmation
            document.getElementById('confirmReview').addEventListener('click', submitReview);

            // Date filter change
            document.getElementById('dateFilter').addEventListener('change', () => {
                if (activeSection === 1) {
                    loadCompletedVideos();
                }
            });
        }

        async function loadEmployees() {
            try {
                const response = await fetch('/api/employees');
                if (!response.ok) {
                    throw new Error('Sunucu yanıt vermedi');
                }
                
                const result = await response.json();
                const select = document.getElementById('employeeSelect');
                
                // Önce select'i temizle
                select.innerHTML = '';
                
                // Her zaman placeholder seçeneğini ekle
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = 'Personel/Stajyer Seçiniz';
                placeholderOption.selected = !currentEmployeeId; // Eğer seçili personel yoksa bunu seç
                placeholderOption.disabled = true;
                select.appendChild(placeholderOption);
                
                if (result.type === 'success' && result.data && result.data.length > 0) {
                    result.data.forEach(employee => {
                        const option = new Option(employee.name, employee.id);
                        select.add(option);
                    });
                    return true;
                } else {
                    const container = document.getElementById('todaysWorks');
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-info-circle"></i>
                                <span>Henüz personel tanımlı değil.</span>
                            </div>
                        </div>`;
                    return false;
                }
            } catch (error) {
                console.error('Error loading employees:', error);
                showAlert('Hata', 'Personel listesi yüklenirken bir hata oluştu. Lütfen sayfayı yenileyiniz.', 'error');
                return false;
            }
        }

        async function loadTodaysWorks(employeeId) {
            const container = document.getElementById('todaysWorks');
            
            if (!employeeId) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-info-circle"></i>
                            <span>Lütfen personel/stajyer seçiniz</span>
                        </div>
                    </div>`;
                return;
            }

            try {
                const response = await fetch(`/api/works`);
                if (!response.ok) {
                    throw new Error('API yanıtı başarısız');
                }

                const data = await response.json();
                // Eğer data boş veya undefined ise boş array kullan
                const works = Array.isArray(data) ? data : (data.data || []);

                container.innerHTML = '';

                // Get today's date in local timezone
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const todayWorks = works.filter(work => {
                    if (!work || !work.startTime || !work.employeeId) return false;
                    const workDate = new Date(work.startTime);
                    workDate.setHours(0, 0, 0, 0);
                    return workDate.getTime() === today.getTime() && 
                           work.employeeId.toString() === employeeId.toString();
                });

                if (todayWorks.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">Bugün için henüz iş kaydı bulunmuyor</div>';
                    return;
                }

                // Sort works by start time (newest first)
                todayWorks.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

                todayWorks.forEach(work => {
                    container.appendChild(createWorkCard(work));
                });
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('todaysWorks').innerHTML = '';
            }

            // Create a new event listener for check-revise-btn
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('check-revise-btn')) {
                    const videoId = e.target.getAttribute('data-video-id');
                    const description = e.target.getAttribute('data-description');
                    
                    fetch('/api/work/' + videoId)
                        .then(response => response.json())
                        .then(video => {
                            if (video.employeeId === currentEmployeeId) {
                                startRevision(videoId, description);
                            } else {
                                showAlert('Uyarı', 'Bu videoyu revize etme yetkiniz yok', 'warning');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showAlert('Hata', 'Video bilgileri alınırken bir hata oluştu', 'error');
                        });
                }
            });
        }

        function createWorkCard(work) {
            const card = document.createElement('div');
            card.className = `card work-card ${work.status === 'completed' ? 'completed' : 'in-progress'} mb-3`;
            
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';

            // Calculate duration for completed works
            let durationText = '';
            if (work.status === 'completed') {
                const startTime = new Date(work.startTime);
                const endTime = new Date(work.endTime);
                
                // Eğer bitiş zamanı başlangıç zamanından küçükse, bir sonraki güne geçmiş demektir
                if (endTime < startTime) {
                    endTime.setDate(endTime.getDate() + 1);
                }
                
                const durationMinutes = Math.round((endTime - startTime) / (1000 * 60));
                const hours = Math.floor(durationMinutes / 60);
                const minutes = durationMinutes % 60;
                durationText = hours > 0 ? 
                    `${hours} saat ${minutes} dakika` : 
                    `${minutes} dakika`;
            }

            const content = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">
                        ${work.workType === 'video' ? 'Video' : 
                          work.workType === 'review' ? 'Video İncelemesi' :
                          work.workType === 'revize' ? 'Revize' : 'Yazılım'}
                    </h5>
                    <span class="status-badge ${work.status === 'completed' ? 'completed' : 'in-progress'}">
                        <i class="bi ${work.status === 'completed' ? 'bi-check-circle' : 'bi-clock-history'}"></i>
                        ${work.status === 'completed' ? 'Tamamlandı' : 'Devam Ediyor'}
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <span class="text-muted">Başlangıç:</span> ${formatTime(work.startTime)}
                    </div>
                    <div>
                        ${work.status === 'completed' ? 
                            `<span class="text-muted">Bitiş:</span> ${formatTime(work.endTime)}` : 
                            '<span class="text-warning"></span>'}
                    </div>
                </div>
                ${work.status === 'completed' ? 
                    `<div class="text-muted mb-2">Süre: ${durationText}</div>` : 
                    ''}
                ${work.workType === 'review' ? `
                    <div class="review-details">
                        <p class="mb-3"><strong>İncelenen Video:</strong> ${work.description}</p>
                        ${work.videoLink ? `
                            <a href="${work.videoLink}" target="_blank" class="btn btn-primary btn-sm">
                                <i class="bi bi-play-circle"></i> Videoyu Görüntüle
                            </a>
                        ` : ''}
                        ${work.status === 'completed' ? `
                            <div class="alert alert-info mt-3 mb-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="mb-0"><strong>İnceleme Yorumu:</strong> ${work.description.replace('Video İncelemesi: ', '')}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                ` : `
                    ${work.workType === 'video' || work.workType === 'revize' || work.workType === 'software' ? `
                    <div class="edit-container">
                        <div class="edit-content">
                            <strong>İş Tanımı:</strong> ${work.description}
                        </div>
                        <div class="edit-buttons">
                            ${work.status !== 'completed' ? `
                                <button class="edit-btn" onclick="editDescription('${work.id}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    ${work.status === 'completed' ? `
                        <div class="edit-container">
                            <div class="edit-content d-flex align-items-center justify-content-between w-100">
                                <div class="video-actions-container">
                                    <a href="${work.videoLink}" target="_blank" class="video-action-btn view-btn">
                                        <i class="bi bi-play-circle"></i> Videoyu Görüntüle
                                    </a>
                                    ${work.employeeId === currentEmployeeId && work.reviews?.length > 0 && work.revisionStatus === 'needs_revision' ? `
                                        <button class="video-action-btn revise-btn" 
                                                onclick="startRevision('${work.id}')"
                                                id="revise-btn-${work.id}"
                                                ${work.isBeingReviewed ? 'disabled' : ''}>
                                            <i class="bi bi-pencil-square"></i>
                                            ${work.isBeingReviewed ? 'Revize Başlatıldı' : 'Revize Et'}
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="edit-buttons">
                                ${work.status !== 'completed' ? `
                                    <button class="edit-btn" onclick="editVideoLink('${work.id}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                ` : ''}
                    ${work.workType === 'video' && work.status === 'completed' && work.reviews?.length > 0 ? `
                        <div class="reviews-section mt-2">
                            <h6 class="text-muted mb-1">İnceleme Yorumları</h6>
                            ${work.reviews.map(review => `
                                <div class="alert ${review.reviewerId === 'admin' ? 'alert-danger' : 'alert-info'} mb-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <p class="mb-1">${review.comment}</p>
                                            <small class="text-muted">
                                                ${review.reviewerName} - ${formatTime(review.createdAt)}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            ${work.employeeId === currentEmployeeId ? `
                                <div class="d-flex justify-content-end mt-2">
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                `}
                
                ${work.status !== 'completed' ? `
                    <div class="complete-btn-container">
                        <button class="action-btn btn-complete" onclick="openCompleteModal('${work.id}')">
                            <i class="bi bi-check-lg"></i> Tamamlandı
                        </button>
                    </div>
                ` : ''}
            `;

            cardBody.innerHTML = content;
            card.appendChild(cardBody);

            // Disable link editing if video or revision is being reviewed or has been reviewed
            if ((work.workType === 'video' || work.workType === 'revize') && work.status === 'completed') {
                const editBtn = cardBody.querySelector('.edit-btn');
                if (editBtn && (work.reviews?.length > 0 || work.isBeingReviewed)) {
                    editBtn.style.display = 'none';
                }
            }

            return card;
        }

        function formatTime(dateString) {
            return new Date(dateString).toLocaleTimeString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function openCompleteModal(workId) {
            selectedWorkId = workId;
            try {
                const response = await fetch(`/api/work/${workId}`);
                const work = await response.json();

                if (work.workType === 'review') {
                    // For review tasks, directly show comment input
                    Swal.fire({
                        title: 'İnceleme Yorumu',
                        input: 'textarea',
                        inputLabel: 'Yorumunuz',
                        inputPlaceholder: 'İnceleme yorumunuzu yazın...',
                        inputAttributes: {
                            'aria-label': 'İnceleme yorumu'
                        },
                        showCancelButton: true,
                        confirmButtonText: 'Tamamla',
                        cancelButtonText: 'İptal',
                        inputValidator: (value) => {
                            if (!value) {
                                return 'Lütfen bir yorum yazın!';
                            }
                        }
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            await completeReview(result.value);
                        }
                    });
                } else {
                    // For video tasks, show link input modal
                    document.getElementById('workLink').value = '';
                    completeWorkModal.show();
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Hata', 'İş detayları yüklenirken bir hata oluştu', 'error');
            }
        }

        async function completeReview(comment) {
            try {
                const reviewWork = await fetch(`/api/work/${selectedWorkId}`).then(r => r.json());
                const videoResponse = await fetch(`/api/work/${reviewWork.reviewedVideoId}`);
                const video = await videoResponse.json();

                // Get employee details
                const employeeName = document.getElementById('employeeSelect').options[
                    document.getElementById('employeeSelect').selectedIndex
                ].text;

                // Create new review object
                const newReview = {
                    reviewerId: currentEmployeeId,
                    reviewerName: employeeName,
                    comment: comment,
                    createdAt: new Date().toISOString()
                };

                let updateData = {};
                
                if (video.isRevisionCompleted) {
                    // Revize edilmiş video için
                    const revisionResponse = await fetch(`/api/work/${video.reviewedVideoId}`);
                    const revisionWork = await revisionResponse.json();
                    
                    // Revizyon incelemelerini güncelle
                    const currentReviews = revisionWork.reviews || [];
                    updateData = {
                        reviews: [...currentReviews, newReview],
                        isReviewed: true,
                        needsAdminReview: true,
                        revisionReviewers: [...(revisionWork.revisionReviewers || []), currentEmployeeId]
                    };

                    // Revizyon işini güncelle
                    await fetch(`/api/work/${video.reviewedVideoId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                } else {
                    // Orijinal video için
                    const currentReviews = video.reviews || [];
                    updateData = {
                        reviews: [...currentReviews, newReview],
                        isReviewed: true,
                        needsAdminReview: true,
                        reviewers: [...(video.reviewers || []), currentEmployeeId]
                    };

                    // Videoyu güncelle
                    await fetch(`/api/work/${reviewWork.reviewedVideoId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                }

                // İnceleme işini tamamla
                const updateReviewResponse = await fetch(`/api/work/${selectedWorkId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        endTime: new Date().toISOString(),
                        status: 'completed',
                        reviews: [newReview] // İncelemeyi kaydet
                    })
                });

                if (!updateReviewResponse.ok) {
                    throw new Error('İnceleme tamamlanırken bir hata oluştu');
                }

                await loadTodaysWorks(currentEmployeeId);
                showAlert('Başarılı', 'İnceleme başarıyla tamamlandı', 'success');

            } catch (error) {
                showAlert('Hata', error.message, 'error');
            }
        }

        async function completeWork() {
            const videoLink = document.getElementById('workLink').value;
            const endTime = new Date().toISOString();
            const selectedWork = await fetch(`/api/work/${selectedWorkId}`).then(r => r.json());

            try {
                // İşi tamamla
                const response = await fetch(`/api/work/${selectedWorkId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        endTime: endTime,
                        videoLink: videoLink,
                        status: 'completed',
                        // Eğer revize işiyse, revize edilmiş videoyu da inceleme döngüsüne sok
                        ...(selectedWork.workType === 'revize' ? {
                            needsEmployeeReview: true,
                            isRevisionCompleted: true,
                            isBeingReviewed: false,  // Yeni inceleme döngüsü için hazır
                            revisionStatus: 'pending', // Onay durumunu sıfırla
                            reviews: [] // İnceleme yorumlarını sıfırla
                        } : {})
                    })
                });

                if (!response.ok) {
                    throw new Error('İş tamamlanırken bir hata oluştu');
                }

                if (selectedWork.workType === 'revize') {
                    // Orijinal videoyu güncelle - artık bu revizyon tamamlandı
                    await fetch(`/api/work/${selectedWork.reviewedVideoId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            isRevisionCompleted: true,
                            isBeingReviewed: false
                        })
                    });
                }

                completeWorkModal.hide();
                document.getElementById('completeWorkForm').reset();
                await loadTodaysWorks(currentEmployeeId);
                await loadCompletedVideos(); // Tamamlanmış videoları da yenile
                showAlert('Başarılı', 'İş başarıyla tamamlandı', 'success');
            } catch (error) {
                showAlert('Hata', error.message, 'error');
            }
        }

        function showAlert(title, text, icon) {
            Swal.fire({
                title: title,
                text: text,
                icon: icon,
                confirmButtonText: 'Tamam'
            });
        }

        async function loadCompletedVideos() {
            try {
                const dateFilter = document.getElementById('dateFilter').value;
                const [videosResponse, worksResponse] = await Promise.all([
                    fetch('/api/completed-videos' + (dateFilter ? `?date=${dateFilter}` : '')),
                    fetch('/api/works')
                ]);
                
                const videosResult = await videosResponse.json();
                const worksData = await worksResponse.json();
                
                const completedVideosList = document.getElementById('completedVideosList');
                const container = completedVideosList.querySelector('.list-group');
                
                container.innerHTML = '';
                
                if (videosResult.type === 'success') {
                    const inProgressReviews = worksData.filter(work => 
                        work.workType === 'review' && 
                        work.status === 'in_progress'
                    );

                    const allVideosUnderReview = inProgressReviews.map(work => work.reviewedVideoId);

                    const otherVideos = videosResult.data.filter(filterVideo);

                    if (otherVideos.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <i class="bi bi-camera-video"></i>
                                <p>İncelenebilecek video bulunmuyor.</p>
                            </div>
                        `;
                        return;
                    }

                    otherVideos.forEach(video => {
                        const item = document.createElement('div');
                        item.className = 'video-list-item';
                        item.innerHTML = `
                            <div class="d-flex flex-column h-100">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi bi-person-circle text-primary fs-5"></i>
                                            <span class="fw-medium">${video.employeeName}</span>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi bi-clock text-primary"></i>
                                            <span class="text-muted">${formatTime(video.startTime)}</span>
                                        </div>
                                    </div>
                                    ${video.isRevision ? `
                                        <span class="badge bg-info d-flex align-items-center gap-1 px-2 py-1" 
                                              style="background: linear-gradient(45deg, #0dcaf0, #0aa2c0) !important;">
                                            <i class="bi bi-arrow-repeat"></i>
                                            Revize
                                        </span>
                                    ` : ''}
                                </div>
                                <div class="flex-grow-1 mb-3">
                                    <div class="alert alert-light mb-0" style="background: #f8f9fa; border: 1px solid #e9ecef;">
                                        <p class="mb-0 text-dark">${video.description}</p>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end align-items-center">
                                    <button class="btn btn-primary d-inline-flex align-items-center gap-2 px-4 py-2" 
                                            onclick="openReviewModal('${video.id}')"
                                            style="background: linear-gradient(45deg, #0d6efd, #0b5ed7); border: none; box-shadow: 0 2px 4px rgba(13, 110, 253, 0.2);">
                                        <i class="bi bi-eye"></i>
                                        <span>İncele</span>
                                    </button>
                                </div>
                            </div>
                        `;
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-exclamation-circle"></i>
                            <p>${videosResult.text}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading completed videos:', error);
                showAlert('Hata', 'Tamamlanmış videolar yüklenirken bir hata oluştu', 'error');
            }
        }

        async function openReviewModal(videoId) {
            try {
                const response = await fetch(`/api/work/${videoId}`);
                const video = await response.json();

                Swal.fire({
                    title: 'Video İncelemesi',
                    html: `
                        <div class="text-start">
                            <p><strong>İş Tanımı:</strong> ${video.description}</p>
                            ${video.reviews && video.reviews.length > 0 ? `
                                <div class="alert alert-info mt-3">
                                    <h6 class="mb-2">İnceleme Yorumları</h6>
                                    ${video.reviews.map(review => `
                                        <div class="mb-2">
                                            <p class="mb-1">${review.comment}</p>
                                            <small class="text-muted">${review.reviewerName} - ${formatTime(review.createdAt)}</small>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'İncelemeyi Başlat',
                    cancelButtonText: 'İptal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        startReview(videoId, video);
                    }
                });
            } catch (error) {
                console.error('Error loading video details:', error);
                showAlert('Hata', 'Video detayları yüklenirken bir hata oluştu', 'error');
            }
        }

        async function startReview(videoId, video) {
            try {
                // Set the current reviewing video
                currentlyReviewingVideo = videoId;
                
                const response = await fetch('/api/work', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employeeId: currentEmployeeId,
                        employeeName: document.getElementById('employeeSelect').options[document.getElementById('employeeSelect').selectedIndex].text,
                        workType: 'review',
                        description: video.description,
                        reviewedVideoId: videoId,
                        startTime: new Date().toISOString(),
                        status: 'in_progress'
                    })
                });

                if (!response.ok) {
                    currentlyReviewingVideo = null; // Reset if there's an error
                    throw new Error('İnceleme başlatılırken bir hata oluştu');
                }

                // Start periodic checking for video approval
                const checkApproval = setInterval(() => {
                    if (!currentlyReviewingVideo) {
                        clearInterval(checkApproval);
                        return;
                    }
                    checkVideoApprovalStatus();
                }, CHECK_INTERVAL);

                // İnceleme başlatıldıktan sonra videoyu listeden kaldır
                const videoElement = document.querySelector(`[onclick="openReviewModal('${videoId}')"]`).closest('.list-group-item');
                if (videoElement) {
                    videoElement.remove();
                }

                // Bugünkü işlerim kısmına dön
                document.getElementById('completedVideosList').style.display = 'none';
                document.getElementById('sectionTitle').textContent = 'Bugünkü İşlerim';
                document.getElementById('todaysWorks').style.display = '';
                activeSection = 0;

                await loadTodaysWorks(currentEmployeeId);
                showAlert('Başarılı', 'İnceleme başarıyla başlatıldı', 'success');
            } catch (error) {
                currentlyReviewingVideo = null;
                showAlert('Hata', error.message, 'error');
            }
        }

        async function submitReview() {
            const comment = document.getElementById('reviewComment').value;
            if (!comment) {
                showAlert('Uyarı', 'Lütfen inceleme yorumu yazınız', 'warning');
                return;
            }

            try {
                // Create a new review work
                const response = await fetch('/api/work', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employeeId: currentEmployeeId,
                        employeeName: document.getElementById('employeeSelect').options[document.getElementById('employeeSelect').selectedIndex].text,
                        workType: 'review',
                        description: `Video İncelemesi: ${comment}`,
                        reviewedVideoId: selectedVideoId,
                        startTime: new Date().toISOString(),
                        status: 'in_progress'
                    })
                });

                if (!response.ok) {
                    throw new Error('İnceleme kaydedilirken bir hata oluştu');
                }

                reviewModal.hide();
                await loadTodaysWorks(currentEmployeeId);
                showAlert('Başarılı', 'İnceleme başarıyla başlatıldı', 'success');
            } catch (error) {
                showAlert('Hata', error.message, 'error');
            }
        }

        async function startRevision(videoId) {
            try {
                // Önce kullanıcıdan onay al
                const result = await Swal.fire({
                    title: 'Revize Başlat',
                    text: 'Bu videoyu revize etmek istediğinizden emin misiniz?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Evet, Başlat',
                    cancelButtonText: 'İptal',
                    confirmButtonColor: '#ffc107',
                    cancelButtonColor: '#6c757d'
                });

                // Eğer kullanıcı onay vermediyse işlemi iptal et
                if (!result.isConfirmed) {
                    return;
                }

                // Önce orijinal videoyu al
                const response = await fetch(`/api/work/${videoId}`);
                const originalVideo = await response.json();

                // Yeni revize işi oluştur
                const revisionWork = {
                    employeeId: originalVideo.employeeId,
                    employeeName: originalVideo.employeeName,
                    workType: "revize",
                    description: originalVideo.description,
                    isRevision: true,
                    reviewedVideoId: originalVideo.id,
                    startTime: new Date().toISOString(),
                    status: "in_progress",
                    reviews: [] // Initialize empty reviews array
                };

                const createResponse = await fetch('/api/work', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(revisionWork)
                });

                if (!createResponse.ok) {
                    throw new Error('Revize işi oluşturulurken bir hata oluştu');
                }

                const newRevisionWork = await createResponse.json();

                // Orijinal videoyu güncelle
                const updateResponse = await fetch(`/api/work/${videoId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        isBeingReviewed: true,
                        revisedWorkId: newRevisionWork.id // Link the revision work
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error('Video güncellenirken bir hata oluştu');
                }

                showAlert('Başarılı', 'Revize işi başlatıldı', 'success');
                
                // Hem bugünkü işleri hem de tamamlanmış videoları güncelle
                await loadCurrentWork();
                await loadCompletedVideos();
            } catch (error) {
                showAlert('Hata', error.message, 'error');
            }
        }

        async function completeRevision(workId) {
            try {
                const { value: videoLink } = await Swal.fire({
                    title: 'Revize Video Linki',
                    input: 'text',
                    inputLabel: 'Video Linki',
                    inputPlaceholder: 'Video linkini girin...',
                    showCancelButton: true,
                    confirmButtonText: 'Tamamla',
                    cancelButtonText: 'İptal',
                    inputValidator: (value) => {
                        if (!value) {
                            return 'Lütfen video linkini girin!';
                        }
                    }
                });

                if (videoLink) {
                    const endTime = new Date();
                    const response = await fetch(`/api/work/${workId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            status: 'completed',
                            videoLink: videoLink,
                            endTime: endTime.toISOString(),
                            isRevisionCompleted: true
                        })
                    });

                    if (!response.ok) {
                        throw new Error('İş tamamlanırken bir hata oluştu');
                    }

                    showAlert('Başarılı', 'Revize tamamlandı', 'success');
                    loadCurrentWork();
                }
            } catch (error) {
                showAlert('Hata', error.message, 'error');
            }
        }

        async function createWork() {
            const employeeSelect = document.getElementById('employeeSelect');
            const workType = document.getElementById('workType').value;
            const description = document.getElementById('description').value;

            if (!workType || !description) {
                showAlert('Uyarı', 'Lütfen tüm alanları doldurunuz', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/work', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        employeeId: currentEmployeeId,
                        employeeName: employeeSelect.options[employeeSelect.selectedIndex].text,
                        workType: workType,
                        description: description,
                        startTime: new Date().toISOString(),
                        status: 'in_progress'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'İş kaydedilirken bir hata oluştu');
                }

                // Reset only description and work type
                document.getElementById('description').value = '';
                document.getElementById('workType').value = '';
                
                // Keep employee selection
                employeeSelect.value = currentEmployeeId;
                
                // Always show today's works after creating a new work
                document.getElementById('completedVideosList').style.display = 'none';
                document.getElementById('sectionTitle').textContent = 'Bugünkü İşlerim';
                document.getElementById('todaysWorks').style.display = '';
                activeSection = 0;
                
                // Reload today's works
                await loadTodaysWorks(currentEmployeeId);
                
                showAlert('Başarılı', 'İş başarıyla kaydedildi', 'success');
            } catch (error) {
                console.error('Error creating work:', error);
                showAlert('Hata', error.message || 'İş kaydedilirken bir hata oluştu', 'error');
            }
        }

        function switchSection(button) {
            const currentSection = parseInt(button.getAttribute('data-section'));
            const newSection = currentSection === 0 ? 1 : 0;
            const sections = ['todaysWorks', 'completedVideosList'];
            const titles = ['Bugünkü İşlerim', 'Tamamlanmış Videolar'];

            // Eğer tamamlanmış videolara geçilmek isteniyorsa ve iş türü video değilse, geçişe izin verme
            if (newSection === 1 && document.getElementById('workType').value !== 'video') {
                showAlert('Uyarı', 'Tamamlanmış videolar bölümü sadece video türü seçiliyken görüntülenebilir.', 'warning');
                return;
            }

            // Update button state
            button.setAttribute('data-section', newSection);

            // Show/hide date filter based on section
            const dateFilter = document.getElementById('dateFilter');
            dateFilter.style.display = newSection === 1 ? '' : 'none';

            // Set default date if switching to completed videos
            if (newSection === 1 && !dateFilter.value) {
                dateFilter.value = new Date().toISOString().split('T')[0];
            }

            // Update section visibility and load content
            sections.forEach((section, index) => {
                const element = document.getElementById(section);
                if (index === newSection) {
                    element.style.display = '';
                    document.getElementById('sectionTitle').textContent = titles[index];
                    if (index === 1) {
                        loadCompletedVideos();
                    } else {
                        loadTodaysWorks(currentEmployeeId);
                    }
                } else {
                    element.style.display = 'none';
                }
            });

            activeSection = newSection;
        }

        // Initialize active section
        document.addEventListener('DOMContentLoaded', () => {
            const switchBtn = document.querySelector('.switch-btn');
            switchBtn.setAttribute('data-section', '0');
        });

        async function editDescription(workId) {
            try {
                const response = await fetch(`/api/work/${workId}`);
                if (!response.ok) {
                    throw new Error('İş bilgileri alınamadı');
                }
                const work = await response.json();
                
                // Check if work is completed
                if (work.status === 'completed') {
                    showAlert('Uyarı', 'Tamamlanmış video düzenlenemez', 'warning');
                    return;
                }

                const { value: newDescription } = await Swal.fire({
                    title: 'İş Tanımını Düzenle',
                    input: 'textarea',
                    inputLabel: 'İş Tanımı',
                    inputValue: work.description,
                    showCancelButton: true,
                    confirmButtonText: 'Kaydet',
                    cancelButtonText: 'İptal',
                    inputValidator: (value) => {
                        if (!value) {
                            return 'İş tanımı boş olamaz!';
                        }
                    }
                });

                if (newDescription) {
                    // İş tanımını güncelle
                    const updateResponse = await fetch(`/api/work/${workId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            description: newDescription
                        })
                    });

                    if (!updateResponse.ok) {
                        if (updateResponse.status === 403) {
                            showAlert('Uyarı', 'Tamamlanmış video düzenlenemez', 'warning');
                            return;
                        }
                        throw new Error('İş tanımı güncellenirken bir hata oluştu');
                    }

                    // Eğer bu bir revize işiyse, orijinal video işinin de tanımını güncelle
                    if (work.workType === 'revize' && work.reviewedVideoId) {
                        const originalVideoResponse = await fetch(`/api/work/${work.reviewedVideoId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                description: newDescription
                            })
                        });

                        if (!originalVideoResponse.ok) {
                            throw new Error('Orijinal video iş tanımı güncellenirken bir hata oluştu');
                        }
                    }

                    await loadTodaysWorks(currentEmployeeId);
                    showAlert('Başarılı', 'İş tanımı başarıyla güncellendi', 'success');
                }
            } catch (error) {
                showAlert('Hata', error.message, 'error');
            }
        }

        async function editVideoLink(workId) {
            try {
                const response = await fetch(`/api/work/${workId}`);
                if (!response.ok) {
                    throw new Error('İş bilgileri alınamadı');
                }
                const work = await response.json();

                // Check if work is completed
                if (work.status === 'completed') {
                    showAlert('Uyarı', 'Tamamlanmış video düzenlenemez', 'warning');
                    return;
                }

                const { value: newLink } = await Swal.fire({
                    title: 'Video Linkini Düzenle',
                    input: 'url',
                    inputLabel: 'Video Link',
                    inputValue: work.videoLink || '',
                    showCancelButton: true,
                    confirmButtonText: 'Kaydet',
                    cancelButtonText: 'İptal',
                    inputValidator: (value) => {
                        if (!value) {
                            return 'Video linki boş olamaz!';
                        }
                    }
                });

                if (newLink) {
                    const updateResponse = await fetch(`/api/work/${workId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            videoLink: newLink
                        })
                    });

                    if (!updateResponse.ok) {
                        if (updateResponse.status === 403) {
                            showAlert('Uyarı', 'Tamamlanmış video düzenlenemez', 'warning');
                            return;
                        }
                        throw new Error('Video linki güncellenirken bir hata oluştu');
                    }

                    await loadTodaysWorks(currentEmployeeId);
                    showAlert('Başarılı', 'Video linki başarıyla güncellendi', 'success');
                }
            } catch (error) {
                showAlert('Hata', error.message, 'error');
            }
        }

        async function loadCurrentWork() {
            try {
                // Bugünkü işlerim kısmına dön
                document.getElementById('completedVideosList').style.display = 'none';
                document.getElementById('sectionTitle').textContent = 'Bugünkü İşlerim';
                document.getElementById('todaysWorks').style.display = '';
                activeSection = 0;

                // Bugünkü işleri yeniden yükle
                await loadTodaysWorks(currentEmployeeId);
            } catch (error) {
                console.error('Error loading current work:', error);
                showAlert('Hata', 'Mevcut işler yüklenirken bir hata oluştu', 'error');
            }
        }

        // Her 30 saniyede bir güncellemeleri kontrol et
        function startAutoRefresh() {
            setInterval(() => {
                if (currentEmployeeId) {
                    loadTodaysWorks(currentEmployeeId);
                }
            }, 30000); // 30 saniyede bir
        }

        // Add this new function to check video approval status
        async function checkVideoApprovalStatus() {
            if (!currentlyReviewingVideo) return;
            
            try {
                const response = await fetch(`/api/work/${currentlyReviewingVideo}`);
                const video = await response.json();
                
                if (video.revisionStatus === 'approved') {
                    // Stop the current review if the video was just approved
                    Swal.fire({
                        title: 'Video Onaylandı!',
                        text: 'Bu video admin tarafından onaylandı. İnceleme işlemi sonlandırılıyor.',
                        icon: 'info',
                        confirmButtonText: 'Tamam'
                    }).then(() => {
                        // Reset the review state
                        currentlyReviewingVideo = null;
                        // Reload the current view
                        if (activeSection === 1) {
                            loadCompletedVideos();
                        } else {
                            loadTodaysWorks(currentEmployeeId);
                        }
                    });
                }
            } catch (error) {
                console.error('Error checking video approval status:', error);
            }
        }

        // Add cleanup to the beforeunload event
        window.addEventListener('beforeunload', () => {
            currentlyReviewingVideo = null;
            clearInterval(autoRefreshInterval);
        });

        function filterVideo(video) {
            // Exclude videos created by the current user
            if (video.employeeId === currentEmployeeId) {
                return false;
            }
            
            // Check if current employee has already reviewed this video
            const hasReviewed = video.reviews?.some(review => 
                review.reviewerId === currentEmployeeId
            );

            // Revize edilmiş video kontrolü
            if (video.isRevisionCompleted) {
                const revisionReviewers = video.revisionReviewers || [];
                const hasReviewedRevision = revisionReviewers.includes(currentEmployeeId);
                return !hasReviewedRevision; // Revize edilmiş videoyu henüz incelememişse göster
            }

            // Normal video için kontrol
            return !hasReviewed && !video.isRevisionCompleted;
        }
    </script>
</body>
</html>